# Build OpenWrt R619AC (改进版：缓存、拆分 job、并行化与命令超时)
#
# 说明：
# - 将构建拆成 prepare 和 build 两个 job：prepare 做 download + host/staging 缓存准备并上传 artifact，
#   build 使用缓存/下载的 artifact 进行 target 编译，避免重复耗时工作。
# - 增加 actions/cache 用于 dl / staging_dir / .ccache
# - compile 使用并行 make -j$(nproc) 并用 timeout 控制命令最长运行时间（小于 6 小时），
#   以便在到达硬性上限前有机会优雅退出并上传诊断信息。
#
name: Build OpenWrt R619AC

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: r619ac.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  SSH_ACTIONS: false
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  prepare:
    name: Prepare (download deps, cache)
    runs-on: ubuntu-22.04
    outputs:
      staging-uploaded: ${{ steps.upload-staging.outputs.uploaded }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup timezone
        run: sudo timedatectl set-timezone "$TZ"

      - name: Install dependencies (apt) and ccache
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo apt install -y ccache build-essential curl wget git python3 python3-setuptools \
            gcc-multilib g++-multilib make rsync squashfs-tools subversion unzip \
            libncurses5-dev libncursesw5-dev libssl-dev zlib1g-dev
          # ensure ccache in PATH
          sudo ln -s $(which ccache) /usr/local/bin/gcc || true
          export CCACHE_DIR=${GITHUB_WORKSPACE}/.ccache
          mkdir -p ${CCACHE_DIR}
          echo "::warning ::ccache directory=${CCACHE_DIR}"

      - name: Restore caches (dl / staging_dir / ccache)
        uses: actions/cache@v4
        id: cache-dl
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir
            .ccache
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('**/feeds.conf*','**/.config', env.CONFIG_FILE ) }}-v1

      - name: Clone source
        working-directory: /workdir
        run: |
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: Load custom feeds & config
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default || true
          [ -e files ] && mv files openwrt/files || true
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config || true
          chmod +x $DIY_P1_SH || true
          chmod +x $DIY_P2_SH || true
          # run custom scripts if exist
          [ -e $DIY_P1_SH ] && $GITHUB_WORKSPACE/$DIY_P1_SH || true

      - name: Update & Install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: make defconfig & download (parallel)
        working-directory: openwrt
        run: |
          echo "start_download: $(date -u +%FT%TZ)"
          make defconfig
          # keep download parallel but bounded
          make download -j8 || true
          # remove any tiny/invalid files
          find dl -size -1024c -exec rm -f {} \; || true
          echo "end_download: $(date -u +%FT%TZ)"

      - name: Save staging_dir artifact (if staging_dir exists)
        if: always()
        uses: actions/upload-artifact@v4
        id: upload-staging
        with:
          name: openwrt-staging
          path: |
            openwrt/staging_dir
            openwrt/dl
            .ccache

  build:
    name: Build (use caches/artifact)
    runs-on: ubuntu-22.04
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download staging artifact (from prepare)
        uses: actions/download-artifact@v4
        with:
          name: openwrt-staging
          path: .

      - name: Restore caches (dl / staging_dir / ccache)
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir
            .ccache
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('**/feeds.conf*','**/.config', env.CONFIG_FILE ) }}-v1

      - name: Install build deps (lightweight)
        run: |
          sudo -E apt-get -qq update
          sudo apt install -y ccache build-essential rsync unzip

      - name: Configure ccache env
        run: |
          export CCACHE_DIR=${GITHUB_WORKSPACE}/.ccache
          mkdir -p ${CCACHE_DIR}
          echo "CCACHE_DIR=${CCACHE_DIR}"
          echo "PATH=/usr/lib/ccache:$PATH"

      - name: Build firmware (with timeout and timestamps)
        id: compile
        working-directory: openwrt
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache
        run: |
          echo "build_start: $(date -u +%FT%TZ)"
          echo -e "$(nproc) threads"
          # use command-level timeout less than GitHub 6h limit to allow graceful cleanup (330m = 5.5h)
          timeout --preserve-status 330m make -j$(nproc) V=s || RC=$?
          echo "build_end: $(date -u +%FT%TZ)"
          # export status so downstream steps can check
          if [ -f bin/targets/*/* ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME || true
            [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
            echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit ${RC:-1}
          fi

      - name: Check space usage
        if: always()
        run: df -hT

      - name: Upload bin directory
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin

      - name: Organize files
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && steps.compile.outputs.status == 'success'
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages || true
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload firmware directory
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: Generate release tag
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success'
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          touch release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.LEO_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 20
          keep_minimum_runs: 5

      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@v0.1.0
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success'
        with:
          keep_latest: 8
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.LEO_TOKEN }}
